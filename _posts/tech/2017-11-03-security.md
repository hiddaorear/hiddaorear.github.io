---
layout: post
title:  Web前端安全
category: 技术
tags: [security]
keywords: security
description:
---

##  Web前端安全

#### Monday, 06  2017 November

![14](/../../assets/img/tech/2017/14.jpg)

## 本质

浏览器的同源策略，和前端代码的跨站需求，之间的灰色地带，是安全的薄弱之处。前端有需要做跨域的地方，如常用jsonp，以及有时候需要利用script标签，以及img标签处理请求，如常见的错误上报就可以使用img标签发送请求，简单的处理跨域问题。虽然浏览器有严格的策略，但由于前端技术灵活，总有办法突破浏览器的防御策略。安全无小事，不可不慎之。

## 第一原则

主要是利用JavaSript，以及HTML标签的特性。只有我们了解这些特性，才能避免这些漏洞。（这个部分知识结构零散，且我研究不深，随口总结一句，聊胜于无吧）

# 知识结构

## XSS

Cross Site Scripting即跨站脚本，重点在最后一个S，即脚本。通俗的说，XSS就是在浏览器解析渲染HTML文档的时候执行的不预期的脚本。

反射型XSS

反射型的XSS，如在URL中附带了脚本，发送请求，服务器解析并响应，浏览器执行了XSS代码。整个过程，从浏览器URL到服务器，在回到浏览器，整个过程中，服务器如同一面镜子，请求如同光线，光线通过镜子反射回浏览器，取名一个很形象的名字：反射。

存储型XSS

与反射型XSS不同，存储型XSS顾名思义，会存储在服务器。最典型的有富文本编辑器中，提交JavaScript代码。

DOM XSS

于前两者都不相同，DOM XSS不需要服务器参与。如在URL后加上`#alert(1)`，而HTML中有`eval(location.hash.subsrt(1))`，这个通过锚点，就无需服务器参与了。

## CSRF

Cross Site Request Forgery，跨站请求伪造。这个名字不是很贴切，因为请求伪造，不一定就跨站了，例如通过XSS就可以不必跨站，照样可以发出请求，但这个请求不是用户按自己意愿发出的，这个，也可以称之为请求伪造。

原理也很简单，目标网站A：www.a.com，恶意网站B：www.b.com。A网站用户已经登陆了，诱使用户访问B网站，B网站有`<img src="http://www.a.com/blog/del?id=1">`类似的代码，发送了一个跨站请求，自动带上了cookie，攻击就发生了。

三个关键点：

1、 用户登陆了，是认证身份之后发生的

2、跨域发送请求

3、可以无需JavaScript参与

其实以上三条，最为关键的是发生在身份认证之后。其余的两条，可有可无。


## 界面操作劫持

这个原理相比之下，更加简单，就是用iframe，再加上一个透明层，就简单劫持了。

## 防御

### HTTP响应的头部

HTTP响应的拓展的头部字段，以`X-`开头。于前端安全相关的有一下三个：

1、`X-Frame-Options` 两个值，DENY，即禁止被加载frame，避免了界面操作劫持。SAMEORIGIN，仅允许同域加载frame。为何不能全面禁用呢？因为网站有时需要加载第三方页面。

2、`X-XSS-Protection` 三个值，0是禁用这个策略，1是默认值，阻止在浏览器上渲染执行，1加上`mode=block`则是强制不渲染。

3、`X-Content-Security-Policy`最佳方案，CSP，如果前端页面中HTML和JavaScript以及CSS分离了，则提高了XSS的难度。

### 域名分离

不同业务域名分离，如果其中一个域名出现了XSS，不至于影响到其他域名。如`http://www.google.com/enterprise`，和广告有关内容，在访问的时候会跳转到`http://static.googleusercontent.com`。

当然，我们也会见到糟糕的域名设计，子域名都放在一个顶级域名之下，任何一个子域名有XSS，都可以影响到顶级域名。

### 使用https，防止明文抓包

### HttpOnly Cookie

严格设置为https传输，即使XSS盗取了，也无法正确使用

### 验证码

防止脚本之类的大量注册

### XSS防御

输入校验，是否合法无害；输出要编码。

### CSRF防御

1、Referer是否同域

2、限制cookie的生命周期

3、验证码

4、一次性token

验证码会对用户造成影响，而token则时效性不易保证，需要更改表单的字段，同时还多了一步token生成和校验。这里还有作者提出的一个方案，在提交表单的时候，临时生成一个cookie字段，1秒之后过期，服务端校验一下这个字段，无则认为是CSRF攻击。如此可以防御CSRF，无他，不过是利用浏览器的同源策略，cookie只能在父域名和子域名之间设置。

### 界面操作劫持防御

设置`X-Frame-Options`即可。



## 参考资料：

Web前端黑客技术揭秘 by 钟晨鸣 徐少培

Yvan say：说来惭愧，第一次遇到web前端安全问题，是刚入行不久的一次面试中。那时候，知道写一些基本的前端页面，安全问题自然没有涉及过，后来才知道，原来前端也有安全问题。后来买了一本书，《Web前端黑客技术揭秘》，兴匆匆买来，因买书太多，就放着了，一放就是三两年了。如今，拿起来读，发现写得很用心，强过了网上很多人的写的安全方面的文章。

我简单的把这本所写的前端安全知识，做一下总结，相当于读书笔记吧。
