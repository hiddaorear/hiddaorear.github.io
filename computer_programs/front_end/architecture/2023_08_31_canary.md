# 灰度发布

## Why：为什么需要灰度发布？

产品更新迭代快，安卓和iOS开发等客户端领域，由于客户端版本因素，用客户端native开发的方式，可能满不了产品快速更新、快速覆盖的要求。新版本需要双端开发，开发人力成本高；版本审核流程长，时间久，会大大影响需求迭代的节奏。因此，往往会借鉴Web技术能力，超越客户端的版本限制。最简单的，用webview承载部分性能要求不高的需求，安卓和iOS只需开发一份，无需双端开发，降低了人力成本。同时可以通过下发JS包，动态更新，实现所谓的动态化功能，超越了客户端的版本限制。

相对客户端版本而言，这种方式非常灵活。正因为如此，往往更容易引发线上问题。甚至对客户端封装的接口的不当调用，引发客户端crash。

也因为灵活，项目可以快速推进，就有很多版本，需要考虑版本管理。

更有甚者，可能会遇到线上的历史版本有问题，被大量的用户投诉。

金丝雀（Canary）发布，来自以前矿工为了辨别矿井是否有毒气，随身携带一只金丝雀。金丝雀对毒气敏感，遇到毒气，会先挂掉，从而有预警作用。灰度发布，本质上也是一种风险控制，以较小的代价来试错。

## What：灰度发布是什么？



### 可屏蔽有问题版本



### 可多版本发布共存

平台可以存在多个版本资源，能标识出不同版本的可用状态，和优先级。

### 版本允许多个灰度阶段



可配置：

可恢复：

可追溯：

## How：灰度发布所需模块

### 分桶规则

灰度平台制定策略，针对不同人群，不同入口等等，下发不同的版本。

常见的有：服务器ip白名单，模运算分桶，正则匹配，用户cookie，url参数，ip，uid。

### 灰度策略

分桶规则和灰度版本号映射关系

### 策略路由

根据业务请求所携带信息，匹配灰度策略。



#### 2023/08/31


## log

- 2023/08/31 创建文档
- 2023/09/01 初稿
