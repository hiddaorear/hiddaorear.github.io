# 灰度发布

## Why：为什么需要灰度发布？

当产品需求多，迭代速度快，在安卓和iOS开发等客户端领域，用客户端 native 开发的方式，难以满足快速更新、快速覆盖的要求。

- 首先，新版本需要双端开发，开发人力成本高；
- 其次，版本审核流程长，时间久，会大大影响需求迭代的节奏。

因此，往往会借鉴或借用Web技术能力，超越客户端的版本限制。最简便的办法，用 webview 承载部分性能要求不高的需求，安卓和iOS只需开发一份，无需双端开发，降低了人力成本。同时可以通过下发JS包，动态更新，实现所谓的动态化功能，超越了客户端的版本限制，规避了客户端 native 开发的缺点。还可以更进一步，充分利用 native 的能力，使用 React Native 或 Flutter 等动态化架构，既能动态更新，也有相对不错的性能。

无论用 Webview 还是动态化架构，一般都需要下发脚本代码，如JavaScript包。以此规避客户端版本问题。

这种方式更灵活，规避了客户端版本更新的限制。这种灵活性，是一把双刃剑，既能快速迭代支持需求，也容易造成线上问题。对客户端封装的接口的不当调用，下发的配置或参数问题，引发客户端crash，时有发生。

因此，就需要慎重考虑版本管理问题，规避线上大的风险。

金丝雀（Canary）发布，来自以前矿工为了辨别矿井是否有毒气，随身携带一只金丝雀。金丝雀对毒气敏感，遇到毒气，会先挂掉，从而有预警作用。灰度发布，本质上也是一种风险控制，以较小的代价来试错。

## What：灰度发布是什么？



### 可屏蔽有问题版本



### 可多版本发布共存

平台可以存在多个版本资源，能标识出不同版本的可用状态，和优先级。

### 版本允许多个灰度阶段



可配置：

可恢复：

可追溯：

## How：灰度发布所需模块

### 分桶规则

灰度平台制定策略，针对不同人群，不同入口等等，下发不同的版本。

常见的有：服务器ip白名单，模运算分桶，正则匹配，用户cookie，url参数，ip，uid。

### 灰度策略

分桶规则和灰度版本号映射关系

### 策略路由

根据业务请求所携带信息，匹配灰度策略。



#### 2023/08/31


## log

- 2023/08/31 创建文档
- 2023/09/01 初稿
